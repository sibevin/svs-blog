<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><title>Deploy railsåˆ°aws | é­”æ³•å¸«çš„æ‰‹æ–</title><meta content="Kait's Blog - åˆ†äº«è‡ªå·±å¯«ç¨‹å¼çš„ç­†è¨˜" name="description" /><link href="//cdn.jsdelivr.net/highlight.js/8.7.0/styles/hybrid.min.css" rel="stylesheet" /><link href="/css/application.css" rel="stylesheet" /><script crossorigin="anonymous" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" src="https://code.jquery.com/jquery-2.2.4.min.js"></script><script src="//cdn.jsdelivr.net/highlight.js/8.7.0/highlight.min.js"></script><script src="/js/consts/metadata.js"></script><script src="/js/vendor/md5.min.js"></script><script src="/js/vendor/contents.js"></script><script src="/js/vendor/emojify.min.js"></script><script type="text/javascript">var FILE = "2015-11-03-152908-deploy-rails-to-aws";
hljs.initHighlightingOnLoad();</script></head><body><div id="app"><div class="post layout" v-bind:class="{'lo-toc-on': tocTb.isTab('on')}"><div class="lo-page lo-simple"><div class="pt-header" id="app"><div class="pt-title">{{ currentPost.title }}</div><div class="pt-datetime">{{ currentPost.datetime }}</div><div class="pt-info"><div class="pt-tags"><div class="tag-area"><div class="tag" v-bind:style="{ background: tagMap[tag].color }" v-for="tag in currentPost.tags"><a class="tag-link" v-bind:href="'/tag?t=' + tag">{{ tagMap[tag].name }}</a></div></div></div><div class="pt-category"><div class="category-icon"><a v-bind:href="'/category/' + currentPost.category"><div v-bind:class="'ca-icon-' + currentPost.category"></div></a></div></div></div></div><div class="pt-content"><div class="meta-data">title Deploy railsåˆ°aws</div><div class="meta-data">datetime 2015-11-03 15:29:08</div><div class="meta-data">tags rails,rails_deploy</div><div class="meta-data">category coding</div><div class="meta-data">link deploy-rails-to-aws</div><div class="meta-data">file 2015-11-03-152908-deploy-rails-to-aws</div><div class="meta-data">template post</div><div class="meta-data">end</div><h1>åœ¨AWSé–‹ä¸€å€‹EC2</h1><h2>åˆ°Amazon Web Services > EC2 > EC2 Dashboard > Launch Instance</h2><h2>å»ºç«‹ä¸€å€‹EC2</h2><ul><li>Step1: é¸AMIï¼š Amazon Linux AMI 2015.09.1 (HVM), SSD Volume Type</li><li>Step2: é¸Instance Type</li><li>Step3: è¨­å®šInstance</li><li>Step4: è¨­å®šStorage</li><li>Step5: è¨­å®šTag</li><li>Step6: è¨­å®šSecurityGroupï¼š Create a new security group > å‘½åname(ä¾‹å¦‚ï¼štest-app-group)ï¼ŒåŠ ä¸€å€‹æ–°çš„rule(HTTP/TCP/80/Anywhere)ã€‚</li><li>Create a new key pair > å‘½å test_app_key > Download Key Pair</li><li>Review and Launch > Launch</li></ul><h2>è¨­å®šEC2èˆ‡Elastic IPs</h2><ul><li>EC2 > Instances > é¸å–å‰›å‰›å»ºç«‹çš„instance</li><li>ä¸‹é¢æœƒå‡ºç¾instanceç›¸é—œçš„è³‡è¨Šï¼Œé‡è¦çš„å…©å€‹è³‡è¨Šæ˜¯ Public DNS èˆ‡ Public IPã€‚</li><li>EC2 > Elastic IPs</li><li>Allocate New Address > Allocate</li><li>é¸å–å‰›å‰›å»ºç«‹çš„EIPï¼ŒActions > Associate Address > é¸å–å‰›å‰›å»ºç«‹çš„instance</li><li>å›åˆ° Instancesï¼Œå‰›å‰›å»ºç«‹çš„instanceçš„ Elastic IP æœƒå‡ºç¾ï¼Œè€Œ Public IP ä¹Ÿæœƒè¢«æ”¹æˆè·Ÿ Elastic IP ä¸€æ¨£ï¼Œé€™ä¹Ÿæ˜¯æœ€çµ‚é€£ç·šåˆ°é€™å€‹instanceç”¨çš„å°å¤–IP(ä¾‹å¦‚ï¼š53.11.132.42)ã€‚</li></ul><h2>sshè‡³EC2</h2><ul><li>åˆ°æœ¬æ©Ÿç«¯ï¼Œå°‡å‰›å‰›ä¸‹è¼‰çš„ test_app_key.pem æ”¾åˆ° ~/.ssh</li><li>æ›´æ”¹keyçš„å­˜å–æ¬Šé™</li></ul><pre><code class="nohighlight">$ chmod 600 ~/.ssh/test_app_key.pem</code></pre><ul><li>é€£ç·šè‡³EC2</li></ul><pre><code class="nohighlight">$ ssh ec2-user@53.11.132.42 -i ~/.ssh/test_app_key.pem
The authenticity of host '53.11.132.42 (53.11.132.42)' can't be established.
RSA key fingerprint is ca:32:e4:cb:3b:dc:51:27:27:9b:c4:d8:39:f0:24:6a.
Are you sure you want to continue connecting (yes/no)? yes

 __|  __|_  )
_|  (     /   Amazon Linux AMI
___|\___|___|

https://aws.amazon.com/amazon-linux-ami/2015.09-release-notes/
[ec2-user@ip-172-32-26-98 ~]$</code></pre><p>çœ‹åˆ°ä¸Šé¢çš„ç•«é¢è¡¨ç¤ºä½ å·²ç¶“æˆåŠŸçš„é€£ç·šè‡³EC2ã€‚</p><h1>å»ºç«‹RDS</h1><h2>åˆ°Amazon Web Services > RDS > RDS Dashboard > Launch Instance</h2><h2>å»ºç«‹ä¸€å€‹mysql RDS</h2><ul><li>Step1: Select Engine - MySQL > Select</li><li>Step2: Choose database type > Yes/No</li><li>Step3: Specify DB Details > è¨­å®š DB Instance Identifier(instanceçš„åç¨±ï¼Œä¾‹å¦‚ï¼štest-app) / Master Username(mysqlçš„ç®¡ç†æ¬Šé™å¸³è™Ÿï¼Œä¾‹å¦‚ï¼šmysqluser)) / Master Password</li><li>Step4: Configure Advanced Settings > VPC Security Group(å¯ä»¥å…ˆé¸defaultï¼Œä¹‹å¾Œå¯ä»¥æ”¹æ‰) / Database Name(è®“å®ƒæ˜¯ç©ºçš„ï¼Œä¹‹å¾Œå¯ä»¥è‡ªå·±å»º) / Port(mysqlé€£ç·šç”¨çš„portï¼Œä¾‹å¦‚ï¼š5678)</li><li>Launch</li><li>åˆ°RDS Dashboardä¸Šå¯ä»¥çœ‹åˆ°DBçš„instanceæ­£åœ¨å»ºç«‹ï¼Œé»é¸instanceä¹‹å¾Œï¼Œä¸‹æ–¹æœƒå‡ºç¾DBçš„ç´°ç¯€ï¼Œå…¶ä¸­Endpointå°±æ˜¯é€£ç·šçš„hostèˆ‡port(test-app.jfkwohjdwioj8.us-west-2.rds.amazonaws.com:5678)ã€‚</li></ul><h2>è¨­å®š Security Group è®“EC2å¯ä»¥é€£ç·š</h2><ul><li>EC2 > Security Group > Create Security Group</li><li>è¨­å®š Security Group name(ä¾‹å¦‚ï¼štest-app-db) / Description / VPC(é¸é è¨­çš„)</li><li>åœ¨ Inbound åŠ ä¸Šä¸€å€‹æ–°çš„è¨­å®š(Custom TCP Rule/TCP/5678/CustomIP[é¸EC2 instanceæ‰€åœ¨çš„security group])</li><li>å°‡æ–°å»ºç«‹RDSçš„Security Groupæ”¹æˆtest-app-group</li></ul><h2>åœ¨EC2ä¸Šå®‰è£é€£ç·šRDS mysqlè³‡æ–™åº«æœƒç”¨åˆ°çš„package</h2><ul><li>ä½¿ç”¨ec2-useré€£ç·šè‡³serverã€‚</li><li>å®‰è£mysqlæœƒç”¨åˆ°çš„packageã€‚</li></ul><pre><code class="nohighlight">$ sudo yum install mysql</code></pre><ul><li>ä½¿ç”¨mysqlé€£ç·šè‡³RDSï¼Œçœ‹åˆ°ä¸‹é¢çš„ç•«é¢å°±è¡¨ç¤ºé€£ç·šæˆåŠŸäº†ã€‚</li></ul><pre><code class="nohighlight">$ mysql -P 5678 -h test-app.jfkwohjdwioj8.us-west-2.rds.amazonaws.com -u mysqluser -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 20
Server version: 5.6.23-log MySQL Community Server (GPL)

Copyright (c) 2000, 2015, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql></code></pre><h2>å»ºç«‹ä¸€å€‹é€£ç·šç”¨çš„mysqlå¸³è™Ÿèˆ‡ç¶²ç«™æ‰€éœ€è¦çš„è³‡æ–™åº«</h2><p>ç†è«–ä¸Šmysqlçš„ç®¡ç†å¸³è™Ÿä¸æ‡‰è©²æ‹¿ä¾†åšç‚ºå¹³å¸¸é€£ç·šä¹‹ç”¨ï¼Œæ‰€ä»¥æˆ‘å€‘æœƒé–‹å¦ä¸€å€‹å¸³è™Ÿä¸¦è¨­å®šæ¯”è¼ƒä½çš„æ¬Šé™ã€‚é€™æ™‚å€™æˆ‘å€‘è¦æ±ºå®šå¹¾å€‹æ±è¥¿ï¼šé€£ç·šå¸³è™Ÿ(ä¾‹å¦‚ï¼štest_app_user)ã€å¸³è™Ÿå¯†ç¢¼(ä¾‹å¦‚ï¼štest_app_pw)èˆ‡è³‡æ–™åº«çš„åç¨±(ä¾‹å¦‚ï¼štest_app_db)ã€‚å¦å¤–æˆ‘å€‘ä¹Ÿå¯ä»¥é †ä¾¿å»ºç«‹ç¶²ç«™æ‰€éœ€è¦çš„è³‡æ–™åº«ï¼Œé›–ç„¶ä¹Ÿå¯ä»¥ç”¨railsçš„rake db:createä¾†å»ºï¼Œä¸éé‚„è¦ä¸‹è¼‰repoå¯¦åœ¨æœ‰é»éº»ç…©ï¼Œæ‰€ä»¥é€™é‚Šå°±ç›´æ¥ä¸‹æŒ‡ä»¤ä¾†å»ºdbå˜ã€‚</p><ul><li>ä½¿ç”¨mysqlé€£ç·šè‡³RDSã€‚</li><li>å»ºç«‹ä¸€å€‹å¸³è™Ÿä¸¦è¨­å®šæ¬Šé™ã€‚</li></ul><pre><code class="mysql">CREATE USER 'test_app_user'@'%' IDENTIFIED BY 'test_app_pw';
GRANT ALL PRIVILEGES ON 'test_app_db' . * TO 'test_app_user'@'%';
FLUSH PRIVILEGES;</code></pre><ul><li>å»ºç«‹è³‡æ–™åº«ã€‚</li></ul><pre><code class="mysql">CREATE DATABASE IF NOT EXISTS test_app_db DEFAULT CHARACTER SET = 'utf8' DEFAULT COLLATE 'utf8_general_ci';</code></pre><ul><li>ç™»å‡ºmysqlå¾Œï¼Œæˆ‘å€‘å¯ä»¥å°±ä½¿ç”¨test_app_userä¾†é€£ç·šäº†ã€‚</li></ul><pre><code class="nohighlight">$ mysql -P 5678 -h test-app.jfkwohjdwioj8.us-west-2.rds.amazonaws.com -u test_app_user -p</code></pre><h1>è¨­å®šserver</h1><h2>ä½¿ç”¨ec2-useré€£ç·šè‡³serverï¼Œæ›´æ–° package</h2><pre><code class="nohighlight">$ sudo yum update
Loaded plugins: priorities, update-motd, upgrade-helper
No packages marked for update</code></pre><h2>å»ºç«‹ä¸€å€‹æ–°user - appuser</h2><p>appuseræœƒå…·æœ‰sudoæ¬Šé™æ“ä½œserverï¼Œç”¨ä¾†å–ä»£rootèˆ‡ec2-userã€‚</p><ul><li>å»ºç«‹ä¸€å€‹æ–°userï¼Œä¸¦è¨­å®šå¯†ç¢¼</li></ul><pre><code class="nohighlight">$ sudo adduser appuser
$ sudo passwd appuser</code></pre><ul><li>ç·¨è¼¯sudoåå–®ï¼Œè®“appuseræ“æœ‰sudoæ¬Šé™</li></ul><pre><code class="nohighlight">$ sudo visudo
# ...
root    ALL=(ALL)       ALL
appuser ALL=(ALL)       ALL
# ...</code></pre><ul><li>é‡æ–°é–‹æ©Ÿ sudo reboot</li></ul><h2>ä½¿ç”¨appuseré€£ç·šè‡³server</h2><p>åªè¦å°‡æœ¬åœ°ç«¯çš„ public key åŠ åˆ° appuser çš„ .ssh/authorized_keys å³å¯ã€‚</p><ul><li>åœ¨æœ¬åœ°ç«¯æŸ¥çœ‹ ~/.ssh/id_rsa.pub æª”æ¡ˆ</li><li>ä½¿ç”¨ec2-userç·šç·šåˆ°server</li><li>åˆ‡æ›åˆ°appuser</li></ul><pre><code class="nohighlight">$ sudo su - appuser</code></pre><ul><li>å»ºç«‹ .ssh ç›®éŒ„ï¼Œå°‡ ~/.ssh/id_rsa.pub æª”æ¡ˆåŠ åˆ° .ssh/authorized_keys ä¹‹ä¸­ã€‚</li><li>æ›´æ–° .ssh èˆ‡ .ssh/authorized_keys çš„å­˜å–æ¬Šé™ã€‚</li></ul><pre><code class="nohighlight">$ chmod 700 .ssh
$ chmod 600 .ssh/authorized_keys</code></pre><ul><li>å›åˆ°æœ¬æ©Ÿç«¯ï¼Œå°±å¯ä»¥ä½¿ç”¨è‡ªå·±çš„keyä»¥appuserçš„å¸³è™Ÿç™»å…¥ã€‚</li></ul><pre><code class="nohighlight">$ ssh appuser@53.11.132.42 -i ~/.ssh/id_rsa</code></pre><h2>è¨­å®šsshï¼Œé—œé–‰root passwordç™»å…¥åŠŸèƒ½ï¼Œæ›´æ”¹é€£ç·šçš„port</h2><ul><li>ç™»å…¥server</li><li>ç·¨è¼¯ /etc/ssh/sshd_configï¼Œè¨­å®šä¸‹é¢çš„è¨­å®šå€¼</li></ul><pre><code>Port 1234
PermitRootLogin no
PasswordAuthentication no
X11Forwarding no
AllowUsers appuser</code></pre><p>èªªæ˜ä¸€ä¸‹ï¼š</p><p>Port 1234ï¼šæ›´æ”¹sshé€£ç·šæ™‚çš„portç‚º1234ã€‚</p><p>PermitRootLogin noï¼šè¡¨ç¤ºä¸å…è¨±ä½¿ç”¨rooté€²è¡Œç™»å…¥ã€‚</p><p>PasswordAuthentication noï¼šè¡¨ç¤ºä¸èƒ½ä½¿ç”¨å¸³è™Ÿå¯†ç¢¼çš„æ–¹å¼ç™»å…¥ã€‚</p><p>X11Forwarding noï¼šä¸ä½¿ç”¨X11 Forwardingï¼Œå› ç‚ºæˆ‘å€‘ä¸æœƒç”¨åˆ°åœ–å½¢ç•Œé¢ã€‚</p><p>AllowUsers appuserï¼šåªå…è¨± appuser å¯ä»¥sshé€£ç·šã€‚</p><ul><li>é‡è®€sshè¨­å®š</li></ul><pre><code class="nohighlight">$ sudo /etc/init.d/sshd reload</code></pre><ul><li>æ›´æ”¹aws instanceçš„security groupè¨­å®šï¼Œåˆ° EC2 > Security Groups > é»é¸test-app-group > ä¸‹é¢æœƒå‡ºç¾è¨­å®šç´°ç¯€ > Inbound > Edit > æ–°å¢ä¸€å€‹rule(Custom TCP Rule/TCP/1234/Anywhere)ï¼Œæ¥è‘—æŠŠSSHé€™å€‹ruleåˆªæ‰ã€‚</li></ul><ul><li>é€™æ™‚å€™è¦é€£ç·šåˆ°serverï¼Œå°±åªèƒ½é€é appuser é€™å€‹å¸³è™Ÿèˆ‡port 1234ä¾†é€²è¡Œé€£ç·šã€‚</li></ul><pre><code class="nohighlight">$ ssh appuser@53.11.132.42 -i ~/.ssh/id_rsa -p 1234</code></pre><h2>å»ºç«‹deployuser</h2><p>deployuseræ˜¯å°ˆé–€ç”¨ä¾†åšdeployç”¨çš„ï¼Œèˆ‡appuseræœ€å¤§çš„ä¸åŒæ˜¯ï¼Œappuserå…·æœ‰sudoæ¬Šé™ï¼Œè€Œdeployuserå‰‡æ²’æœ‰ã€‚æ‰€ä»¥ä»»ä½•å®‰è£çš„æµç¨‹ï¼Œæ‡‰è©²æ˜¯ç”±appuserä¾†åšï¼Œè€Œdeployæ˜¯ç”±deployuserä¾†åšã€‚</p><ul><li>å»ºç«‹deployuserï¼Œä¸¦è¤‡åˆ¶appuserçš„é€£ç·šè¨­å®š</li></ul><pre><code class="nohighlight">sudo adduser deployuser
sudo mkdir /home/deployuser/.ssh
sudo chown -R deployuser /home/deployuser/.ssh
sudo chgrp -R deployuser /home/deployuser/.ssh
sudo chmod -R 700 /home/deployuser/.ssh

sudo cp .ssh/authorized_keys /home/deployuser/.ssh/authorized_keys
sudo chown deployuser /home/deployuser/.ssh/authorized_keys
sudo chgrp deployuser /home/deployuser/.ssh/authorized_keys

sudo usermod -a -G deployuser appuser</code></pre><ul><li>å°‡deployuseråŠ åˆ°sshçš„è¨­å®šæª”ï¼Œç·¨è¼¯ /etc/ssh/sshd_configï¼Œä¿®æ”¹ä¸‹é¢çš„è¨­å®šå€¼</li></ul><pre><code class="nohighlight">AllowUsers appuser deployuser</code></pre><ul><li>é‡è®€sshè¨­å®š</li></ul><pre><code class="nohighlight">$ sudo /etc/init.d/sshd reload</code></pre><ul><li>é€™æ™‚å€™å°±å¯ä»¥ä½¿ç”¨deployuseré€£ç·šåˆ°serverã€‚</li></ul><pre><code class="nohighlight">$ ssh deployuser@53.11.132.42 -i ~/.ssh/id_rsa -p 1234</code></pre><h1>å®‰è£rvmèˆ‡ruby</h1><h2>å®‰è£rvm</h2><p>rvmçš„åŠŸèƒ½æ˜¯ç”¨ä¾†åˆ‡æ›rubyçš„ç‰ˆæœ¬ï¼Œåœ¨æ—¥å¾Œè¦å‡ç´šrubyæ™‚æœƒçœäº‹å¾ˆå¤šã€‚å¦å¤–æˆ‘å€‘æœƒä½¿ç”¨multi-userçš„æ¨¡å¼ä¾†å®‰è£ï¼Œä¹Ÿå°±æ˜¯rvmæ˜¯å®‰è£åœ¨ç³»çµ±ä¹‹ä¸‹ï¼Œæ‰€æœ‰çš„ä½¿ç”¨è€…ç”¨çš„éƒ½æ˜¯åŒä¸€å¥—rvmã€‚è¦æ³¨æ„çš„æ˜¯ï¼ŒåŸ·è¡Œä¸€èˆ¬çš„rvmæŒ‡ä»¤æ™‚ä¸éœ€è¦sudoæ¬Šé™ï¼Œä½†å¦‚æœè¦å®‰è£rubyï¼Œå°±å¿…é ˆè¦æœ‰sudoæ¬Šé™ã€‚</p><ul><li>åŸ·è¡Œrvmå®‰è£æŒ‡ä»¤ï¼Œç¬¬ä¸€æ¬¡åŸ·è¡Œæœƒå¤±æ•—ï¼Œå®ƒæœƒæç¤ºè¦åŠ å…¥GPG signature</li></ul><pre><code class="nohighlight">$ \curl -sSL https://get.rvm.io | sudo bash -s stable
[sudo] password for appuser:
Downloading https://github.com/rvm/rvm/archive/1.26.11.tar.gz
Downloading https://github.com/rvm/rvm/releases/download/1.26.11/1.26.11.tar.gz.asc
gpg: directory `/root/.gnupg' created
gpg: new configuration file `/root/.gnupg/gpg.conf' created
gpg: WARNING: options in `/root/.gnupg/gpg.conf' are not yet active during this run
gpg: keyring `/root/.gnupg/pubring.gpg' created
gpg: Signature made Mon 30 Mar 2015 09:52:13 PM UTC using RSA key ID BF04FF17
gpg: Can't check signature: No public key
Warning, RVM 1.26.0 introduces signed releases and automated check of signatures when GPG software found.
Assuming you trust Michal Papis import the mpapis public key (downloading the signatures).

GPG signature verification failed for '/usr/local/rvm/archives/rvm-1.26.11.tgz' - 'https://github.com/rvm/rvm/releases/download/1.26.11/1.26.11.tar.gz.asc'!
try downloading the signatures:

    sudo gpg2 --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3

or if it fails:

    command curl -sSL https://rvm.io/mpapis.asc | sudo gpg2 --import -

the key can be compared with:

    https://rvm.io/mpapis.asc
    https://keybase.io/mpapis</code></pre><ul><li>åŠ å…¥GPG signature</li></ul><pre><code class="nohighlight">$ sudo gpg2 --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
gpg: keyring `/root/.gnupg/secring.gpg' created
gpg: requesting key D39DC0E3 from hkp server keys.gnupg.net
gpg: /root/.gnupg/trustdb.gpg: trustdb created
gpg: key D39DC0E3: public key "Michal Papis (RVM signing) &lt;mpapis@gmail.com>" imported
gpg: no ultimately trusted keys found
gpg: Total number processed: 1
gpg:               imported: 1  (RSA: 1)</code></pre><ul><li>åŸ·è¡Œrvmå®‰è£æŒ‡ä»¤</li></ul><pre><code class="nohighlight">$ \curl -sSL https://get.rvm.io | sudo bash -s stable
Downloading https://github.com/rvm/rvm/archive/1.26.11.tar.gz
Downloading https://github.com/rvm/rvm/releases/download/1.26.11/1.26.11.tar.gz.asc
gpg: Signature made Mon 30 Mar 2015 09:52:13 PM UTC using RSA key ID BF04FF17
gpg: Good signature from "Michal Papis (RVM signing) &lt;mpapis@gmail.com>" [unknown]
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: 409B 6B17 96C2 7546 2A17  0311 3804 BB82 D39D C0E3
     Subkey fingerprint: 62C9 E5F4 DA30 0D94 AC36  166B E206 C29F BF04 FF17
GPG verified '/usr/local/rvm/archives/rvm-1.26.11.tgz'
Creating group 'rvm'

Installing RVM to /usr/local/rvm/
Installation of RVM in /usr/local/rvm/ is almost complete:

  * First you need to add all users that will be using rvm to 'rvm' group,
    and logout - login again, anyone using rvm will be operating with `umask u=rwx,g=rwx,o=rx`.

  * To start using RVM you need to run `source /etc/profile.d/rvm.sh`
    in all your open shell windows, in rare cases you need to reopen all shell windows.

# appuser,
#
#   Thank you for using RVM!
#   We sincerely hope that RVM helps to make your life easier and more enjoyable!!!
#
# ~Wayne, Michal & team.

In case of problems: http://rvm.io/help and https://twitter.com/rvm_io</code></pre><ul><li>å°‡appuseråŠ åˆ°rvmçš„groupï¼Œè®“appuserå¯ä»¥åŸ·è¡Œrvm getç­‰ç›¸é—œçš„æŒ‡ä»¤ã€‚</li></ul><pre><code class="nohighlight">sudo usermod -a -G rvm appuser</code></pre><ul><li>ç™»å‡ºå†ç™»å…¥å¾Œï¼Œå°±å¯ä»¥ä½¿ç”¨rvmçš„æŒ‡ä»¤ã€‚</li></ul><pre><code class="nohighlight">$ rvm -v
rvm 1.26.11 (latest) by Wayne E. Seguin &lt;wayneeseguin@gmail.com>, Michal Papis &lt;mpapis@gmail.com> [https://rvm.io/]</code></pre><h2>å®‰è£ruby</h2><ul><li>å–å¾—æœ€æ–°çš„rvmèˆ‡rubyåˆ—è¡¨</li></ul><pre><code class="nohighlight">$ rvmsudo rvm get stable
Downloading https://get.rvm.io
Downloading https://raw.githubusercontent.com/wayneeseguin/rvm/master/binscripts/rvm-installer.asc
Verifying /usr/local/rvm/archives/rvm-installer.asc
gpg: Signature made Tue 14 Apr 2015 12:05:41 AM UTC using RSA key ID BF04FF17
gpg: Good signature from "Michal Papis (RVM signing) &lt;mpapis@gmail.com>" [unknown]
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: 409B 6B17 96C2 7546 2A17  0311 3804 BB82 D39D C0E3
     Subkey fingerprint: 62C9 E5F4 DA30 0D94 AC36  166B E206 C29F BF04 FF17
GPG verified '/usr/local/rvm/archives/rvm-installer'
Downloading https://github.com/rvm/rvm/archive/1.26.11.tar.gz
Downloading https://github.com/rvm/rvm/releases/download/1.26.11/1.26.11.tar.gz.asc
gpg: Signature made Mon 30 Mar 2015 09:52:13 PM UTC using RSA key ID BF04FF17
gpg: Good signature from "Michal Papis (RVM signing) &lt;mpapis@gmail.com>" [unknown]
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: 409B 6B17 96C2 7546 2A17  0311 3804 BB82 D39D C0E3
     Subkey fingerprint: 62C9 E5F4 DA30 0D94 AC36  166B E206 C29F BF04 FF17
GPG verified '/usr/local/rvm/archives/rvm-1.26.11.tgz'

Upgrading the RVM installation in /usr/local/rvm/
Upgrade of RVM in /usr/local/rvm/ is complete.

# appuser,
#
#   Thank you for using RVM!
#   We sincerely hope that RVM helps to make your life easier and more enjoyable!!!
#
# ~Wayne, Michal & team.

In case of problems: http://rvm.io/help and https://twitter.com/rvm_io

Upgrade Notes:

  * No new notes to display.

RVM reloaded!</code></pre><ul><li>ä½¿ç”¨rvmå®‰è£ruby 2.2.3</li></ul><pre><code class="nohighlight">$ rvmsudo rvm install 2.2.3
Searching for binary rubies, this might take some time.
No binary rubies available for: amazon/2015.09/x86_64/ruby-2.2.3.
Continuing with compilation. Please read 'rvm help mount' to get more information on binary rubies.
Checking requirements for amazon.
Installing requirements for amazon.
Installing required packages: patch, libyaml-devel, glibc-headers, autoconf, gcc-c++, glibc-devel, patch, readline-devel, zlib-devel, libffi-devel, openssl-devel, automake, libtool, bison, sqlite-devel........................
Requirements installation successful.
Installing Ruby from source to: /usr/local/rvm/rubies/ruby-2.2.3, this may take a while depending on your cpu(s)...
ruby-2.2.3 - #downloading ruby-2.2.3, this may take a while depending on your connection...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 12.7M  100 12.7M    0     0  8096k      0  0:00:01  0:00:01 --:--:-- 8092k
No checksum for downloaded archive, recording checksum in user configuration.
ruby-2.2.3 - #extracting ruby-2.2.3 to /usr/local/rvm/src/ruby-2.2.3....
ruby-2.2.3 - #configuring.........................................................
ruby-2.2.3 - #post-configuration..
ruby-2.2.3 - #compiling...............................................................................
ruby-2.2.3 - #installing.............................
ruby-2.2.3 - #making binaries executable..
ruby-2.2.3 - #downloading rubygems-2.4.8
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  437k  100  437k    0     0   706k      0 --:--:-- --:--:-- --:--:--  707k
No checksum for downloaded archive, recording checksum in user configuration.
ruby-2.2.3 - #extracting rubygems-2.4.8....
ruby-2.2.3 - #removing old rubygems.........
ruby-2.2.3 - #installing rubygems-2.4.8......................
ruby-2.2.3 - #gemset created /usr/local/rvm/gems/ruby-2.2.3@global
ruby-2.2.3 - #importing gemset /usr/local/rvm/gemsets/global.gems...............................................
ruby-2.2.3 - #generating global wrappers........
ruby-2.2.3 - #gemset created /usr/local/rvm/gems/ruby-2.2.3
ruby-2.2.3 - #importing gemsetfile /usr/local/rvm/gemsets/default.gems evaluated to empty gem list
ruby-2.2.3 - #generating default wrappers........
ruby-2.2.3 - #adjusting #shebangs for (gem irb erb ri rdoc testrb rake).
Install of ruby-2.2.3 - #complete
Ruby was built without documentation, to build it run: rvm docs generate-ri</code></pre><ul><li>æŸ¥çœ‹rubyç‰ˆæœ¬</li></ul><pre><code class="nohighlight">$ rvm ls

rvm rubies

   ruby-2.2.3 [ x86_64 ]

# Default ruby not set. Try 'rvm alias create default &lt;ruby&gt;'.
# => - current
# =* - current && default
#  * - default</code></pre><ul><li>è¨­å®šé è¨­rubyçš„ç‰ˆæœ¬è‡³2.2.3</li></ul><pre><code class="nohighlight">$ rvm use 2.2.3 --default
Using /usr/local/rvm/gems/ruby-2.2.3</code></pre><ul><li>å®‰è£bundler</li></ul><pre><code class="nohighlight">$ gem install bundler --no-ri --no-rdoc
Fetching: bundler-1.10.6.gem (100%)
Successfully installed bundler-1.10.6
1 gem installed</code></pre><h1>è¨­å®šæ”¾ç½®ç¶²é çš„ç›®éŒ„èˆ‡å®‰è£nginx</h1><ul><li>ä½¿ç”¨appuserç™»å…¥åˆ°server</li><li>å»ºç«‹æ”¾ç½®ç¶²é çš„ç›®éŒ„(/opt/www/test-app)ï¼Œä¸¦è¨­å®šç›®éŒ„åªæœ‰deployuserçš„å¸³è™Ÿæˆ–ç¾¤çµ„å¯ä»¥è®€å¯«é€™å€‹ç›®éŒ„çš„æ¬Šé™ã€‚</li></ul><pre><code class="nohighlight">$ sudo mkdir -p /opt/www/test-app
$ sudo chown -R deployuser /opt/www/test-app
$ sudo chgrp -R deployuser /opt/www/test-app
$ sudo chmod -R 775 /opt/www/test-app</code></pre><ul><li>å®‰è£nginx</li></ul><pre><code class="nohighlight">sudo yum install nginx</code></pre><ul><li>è¨­å®šnginx</li></ul><pre><code class="nohighlight">$ sudo mkdir /etc/nginx/sites-available
$ sudo mkdir /etc/nginx/sites-enabled</code></pre><p>ä¸Šé¢çš„å‹•ä½œæœƒåœ¨/etc/nginxå»ºå…©å€‹ç›®éŒ„ï¼Œé€™éº¼åšçš„ç›®çš„æ˜¯æˆ‘å€‘æƒ³å°‡ä¸åŒçš„ç¶²ç«™è¨­å®šæª”åˆ†é–‹ï¼Œå°‡ç¶²ç«™ç›¸é—œçš„è¨­å®šæª”æ”¾åœ¨sites-availableä¹‹ä¸‹ï¼Œå¦‚æœè¦ä¸Šç·šï¼Œå°±å»ºä¸€å€‹linkåˆ°sites-enabledã€‚</p><ul><li>ç·¨è¼¯/etc/nginx/nginx.confï¼Œåœ¨httpçš„blockä¸­include /etc/nginx/sites-enabledé€™å€‹ç›®éŒ„ã€‚</li></ul><p><i>/etc/nginx/nginx.conf</i></p><pre><code class="nohighlight">http {
  # ...
  include /etc/nginx/sites-enabled/*;
  # ...
}</code></pre><ul><li>åœ¨/etc/nginx/sites-availableä¸­å»ºç«‹ä¸€å€‹test_appçš„è¨­å®šæª”</li></ul><p><i>/etc/nginx/sites-available/test_app</i></p><pre><code class="nohighlight">upstream unicorn_test_app {
server unix:/tmp/unicorn.test_app.sock fail_timeout=0;
}

server {
listen 80 default deferred;
server_name test-app.com;
root /opt/www/test-app/current/public;

location ~ ^/assets/ {
gzip_static on;
expires max;
add_header Cache-Control public;
}

try_files $uri/index.html $uri @unicorn;
location @unicorn {
proxy_set_header Host $http_host; Â 
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_redirect off;
proxy_pass http://unicorn_test_app;
}

error_page 500 502 503 504 /500.html;
client_max_body_size 4G;
keepalive_timeout 10;
}</code></pre><ul><li>å»ºç«‹linkåˆ°site-enabledä¾†å•Ÿå‹•test_app</li></ul><pre><code class="nohighlight">$ sudo ln -s /etc/nginx/sites-available/test_app /etc/nginx/sites-enabled/test_app</code></pre><ul><li>é‡å•Ÿnginx</li></ul><pre><code class="nohighlight">$ sudo service nginx start</code></pre><h2>å®‰è£nodejsèˆ‡npm</h2><p>çœŸè¦‹é¬¼äº†ï¼Œyumçš„nodejsç‰ˆæœ¬ä¹Ÿå¤ªèˆŠäº†å§(0.10.36ï¼Œç¾åœ¨5.0.0éƒ½è¦å‡ºäº†è€¶)ï¼Œåªå¥½ç¡¬çš„é ­çš®è‡ªå·±è£äº†ã€‚é‚„å¥½æœ‰é€™ç¯‡å¯ä»¥åƒè€ƒï¼š<a href="http://iconof.com/blog/how-to-install-setup-node-js-on-amazon-aws-ec2-complete-guide/#installNode" target="_blank">How to install & setup Node.js on Amazon EC2 â€“ complete guide</a></p><ul><li>ä½¿ç”¨appuserç™»å…¥serverã€‚</li><li>å®‰è£éœ€è¦ç”¨åˆ°çš„packageã€‚</li></ul><pre><code class="nohighlight">$ sudo yum install gcc-c++ make openssl-devel</code></pre><ul><li>ä¸‹è¼‰nodejsçš„åŸå§‹æª”ã€ç·¨è­¯ä¸¦å®‰è£å®ƒã€‚</li></ul><pre><code class="nohighlight">mkdir temp
cd temp
wget https://nodejs.org/dist/v4.2.2/node-v4.2.2.tar.gz
tar -xf node-v4.2.2.tar.gz
cd node-v4.2.2
./configure
make
sudo make install</code></pre><ul><li>å®‰è£å®Œä¹‹å¾Œç™»å‡ºå†ç™»å…¥ï¼Œå°±æœ‰nodeèˆ‡npmå¯ä»¥ç”¨äº†ã€‚</li></ul><pre><code class="nohighlight">$ node -v
v4.2.2
$ npm -v
2.14.7</code></pre><h2>å®‰è£å…¶å®ƒæœƒç”¨åˆ°çš„package</h2><p>é€™è£¡å°±è·Ÿæ“šä½ çš„éœ€æ±‚å®‰è£éœ€è¦çš„packageï¼Œå¦‚æœå°‘å®‰è£äº†ï¼Œåœ¨deployåšbundle installçš„æ™‚å€™å°±æœƒå‡ºéŒ¯ï¼Œåˆ°æ™‚å€™å†å›ä¾†å®‰è£ä¹Ÿå¯ä»¥ã€‚é€™é‚Šåªè¨˜éŒ„æˆ‘è‡ªå·²æœ‰ç”¨åˆ°çš„package</p><ul><li>ImageMagick - ç”¨ä¾†è™•ç†åœ–ç‰‡æª”æ¡ˆ</li></ul><h2>åœ¨/opt/www/test-appä¸­åŠ å…¥deployæœƒç”¨åˆ°çš„æª”æ¡ˆ</h2><p>secrets.ymlèˆ‡database.ymlæ˜¯railsä¸­æœ€é‡è¦çš„å…©å€‹è¨­å®šæª”ï¼Œç†è«–ä¸Šé€™å…©å€‹æª”æ¡ˆéƒ½ä¸æ‡‰è©²commitåˆ°repoä¸­ã€‚åœ¨åšproduction deployçš„æ™‚å€™æœƒå¾/opt/www/test-app/shared/configçš„ç›®éŒ„ä¸­è¤‡è£½(ç²¾ç¢ºä¾†èªªæ˜¯å»ºç«‹link)åˆ°å¯¦éš›é‹ä½œçš„appç›®éŒ„ä¸­ï¼Œæ‰€ä»¥åœ¨deployä¹‹å‰ï¼Œæˆ‘å€‘è¦å…ˆåœ¨serverä¸Šå°æ‡‰çš„ç›®éŒ„ä¸‹æ‰‹å‹•å»ºç«‹é€™å…©å€‹æª”æ¡ˆã€‚</p><ul><li>ä½¿ç”¨deployuserç™»å…¥serverã€‚</li><li>å»ºç«‹/opt/www/test-app/shared/configç›®éŒ„ï¼Œä¸¦å°‡productionçš„secrets.ymlèˆ‡database.ymlåŠ é€²å»ã€‚é€™è£¡çš„database.ymlæ‡‰è©²æœƒé•·çš„åƒä¸‹é¢é€™å€‹æ¨£å­</li></ul><pre><code class="nohighlight">production:
  adapter: mysql2
  encoding: utf8
  pool: 5
  host: test-app.jfkwohjdwioj8.us-west-2.rds.amazonaws.com
  port: 5678
  database: test_app_db
  username: test_app_user
  password: test_app_pw</code></pre><h1>åœ¨rails appä¸­è¨­å®šdeploy</h1><h2>å®‰è£deployç”¨çš„gem</h2><p>å› ç‚ºæˆ‘å€‘æ˜¯ç”¨nginx + unicornï¼Œæ‰€ä»¥unicornæ˜¯ä¸€å®šè¦è£çš„ã€‚å¦å¤–æˆ‘å€‘æ˜¯ç”¨capistranoä¾†åšdeployï¼Œæ‰€ä»¥ä¸€äº›ç›¸é—œçš„gemä¹Ÿè¦åŠ é€²ä¾†ï¼Œä¸éæœƒæ”¾åœ¨developmentçš„groupä¸­ã€‚</p><pre><code class="nohighlight"># ...
gem 'unicorn'
# ...
group :development do
  # ...
  gem 'capistrano-rails'
  gem 'capistrano-rvm'
  gem 'capistrano-npm'
  gem 'capistrano3-unicorn'
  # ...
end</code></pre><h2>è¨­å®šcapistrano</h2><p>capistranoæ˜¯å°ˆé–€åšdeployçš„å·¥å…·ï¼ŒåŸºæœ¬ä¸Šå®ƒçš„è¨­å®šæª”æ±ºå®šäº†æ•´å€‹deployçš„æµç¨‹ã€‚ä¸‹é¢æ˜¯ä¸€å€‹ç¯„ä¾‹ï¼š</p><p><i>config/deploy.rb</i></p><pre><code class="nohighlight"># config valid only for current version of Capistrano
lock '3.4.0'

set :application, 'app'
set :repo_url, '[your repo]'
set :user, 'deployuser'
set :rails_env, 'production'
set :assets_roles, [:app]
set :npm_roles, [:app]
set :unicorn_roles, [:app]

set :ssh_options, { forward_agent: true, port: 1234 }
set :deploy_to, '/opt/www/test-app'

set :linked_files, fetch(:linked_files, []).push('config/database.yml', 'config/secrets.yml')
set :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle', 'public/system')

set :npm_flags, '--silent --no-spin'

namespace :deploy do
  after :restart, :clear_cache do
    on roles(:app), in: :groups, limit: 3, wait: 10 do
      # Here we can do anything such as:
      # within release_path do
      #   execute :rake, 'cache:clear'
      # end
    end
  end
  task :restart_unicorn do
    invoke 'unicorn:reload'
  end
  after :publishing, :restart_unicorn
end</code></pre><p><i>config/deploy/production.rb</i></p><pre><code class="nohighlight">role :app, %w{53.11.132.42}
role :web,  %w{53.11.132.42}
role :db,  %w{53.11.132.42}</code></pre><h2>è¨­å®šunicorn</h2><p>unicornæ˜¯é€£æ¥web serverèˆ‡rails appçš„rack http serverã€‚æœ‰äº†capistrano3-unicornï¼Œæˆ‘å€‘å¯ä»¥åœ¨config/unicorn/[environment].rbä¸­åŠ ä¸Šunicornçš„è¨­å®šã€‚</p><p><i>config/unicorn/production.rb</i></p><pre><code class="nohighlight">root = "/opt/www/test-app/current"
working_directory rootpid &quot;#{root}/tmp/pids/unicorn.pid&quot;
stderr_path &quot;#{root}/log/unicorn.log&quot;
stdout_path &quot;#{root}/log/unicorn.log&quot;
listen &quot;/tmp/unicorn.test_app.sock&quot;
worker_processes 1
timeout 30</code></pre><h2>é–‹å§‹deploy</h2><ul><li>cap production deploy</li><li>Good Luck</li></ul></div></div><div class="lo-ctrl-panel lo-simple"><div class="ctrl-panel"><div class="lo-toc"><div class="toc"></div></div><div class="cp-menu"><div class="cp-first"></div><div class="cp-middle cp-mu-btn"><a href="/"><img src="/images/header/trademark_50x.svg" /></a></div><div class="cp-middle cp-mu-btn"><a href="/posts"><img src="/images/menu/paper_48x.svg" /></a></div><div class="cp-middle cp-mu-btn"><a href="/tags"><img src="/images/menu/tags_48x.svg" /></a></div><div class="cp-middle cp-mu-btn"><a href="/categories"><img src="/images/menu/category_48x.svg" /></a></div><div class="cp-middle cp-mu-btn"><a v-on:click="tocTb.switch('on')"><img src="/images/menu/toc_48x.svg" /></a></div><div class="cp-middle cp-mu-btn"><a href="/posts"><img src="/images/menu/search_48x.svg" /></a></div><div class="cp-last"></div></div></div></div></div></div><script type="text/javascript">$(function () {
  // TOC
  try {
    var contents,
        articleId;
    articleId = function (articleName, element) {
      return md5(articleName + element.previousSibling.innerText + element.nextSibling.innerText);
    };
    contents = gajus
      .Contents({articleId: articleId});
    $('.toc').append(contents.list());
  } catch(e) {
  }
  // emoji
  emojify.setConfig({
    ignore_emoticons: true,
    img_dir: '/images/emoji',
    blacklist: {
      elements: ['script', 'textarea', 'pre', 'code'],
      classes: ['no-emojify']
    }
  });
  emojify.run();
});</script><script src="/js/post.js"></script></body></html>